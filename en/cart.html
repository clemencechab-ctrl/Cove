<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVE - Cart</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="nav-left">
                <a href="index.html#collection" class="nav-link">Collection</a>
                <a href="index.html#lookbook" class="nav-link">Lookbook</a>
            </div>
            <div class="logo">
                <a href="index.html"><img src="../image/logo-cove.png" alt="COVE"></a>
            </div>
            <div class="nav-right">
                <a href="admin.html" class="nav-link">Administration</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <a href="compte.html" class="nav-link">Account</a>
                <a href="cart.html" class="nav-link cart-link active">
                    Cart (<span id="cart-count">0</span>)
                </a>
            </div>
        </nav>
    </header>

    <!-- Cart Hero -->
    <section class="cart-hero">
        <h1 class="cart-title">Cart</h1>
    </section>

    <!-- Cart Section -->
    <section class="cart-section">
        <div class="cart-container">
            <!-- Cart Items -->
            <div class="cart-items" id="cart-items">
                <!-- Items will be rendered by JavaScript -->
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary" id="cart-summary">
                <h3>Summary</h3>
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotal">0 EUR</span>
                </div>
                <div class="summary-row">
                    <span>Shipping</span>
                    <span id="shipping">Free</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="total">0 EUR</span>
                </div>
                <button class="btn-checkout" id="checkout-btn" onclick="proceedToCheckout()">
                    Checkout
                </button>
                <a href="index.html#collection" class="btn-continue">Continue shopping</a>
            </div>
        </div>

        <!-- Empty Cart Message -->
        <div class="cart-empty" id="cart-empty" style="display: none;">
            <p>Your cart is empty</p>
            <a href="index.html#collection" class="btn-primary">View collection</a>
        </div>
    </section>

    <!-- Checkout Modal -->
    <div class="checkout-modal" id="checkout-modal">
        <div class="checkout-content">
            <button class="checkout-close" onclick="closeCheckout()">&times;</button>
            <h2>Complete your order</h2>

            <form id="checkout-form" onsubmit="submitOrder(event)">
                <div class="checkout-section">
                    <h3>Shipping information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First name</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last name</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" id="address" name="address" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="postalCode">Postal code</label>
                            <input type="text" id="postalCode" name="postalCode" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="country">Country</label>
                        <select id="country" name="country" required>
                            <option value="FR">France</option>
                            <option value="BE">Belgium</option>
                            <option value="CH">Switzerland</option>
                            <option value="LU">Luxembourg</option>
                        </select>
                    </div>
                </div>

                <div class="checkout-section">
                    <h3>Promo code</h3>
                    <div class="promo-code-row">
                        <input type="text" id="promo-code-input" placeholder="Enter a promo code">
                        <button type="button" class="btn-apply-promo" onclick="applyPromoCode()">Apply</button>
                    </div>
                    <div id="promo-message" class="promo-message"></div>
                </div>

                <div class="checkout-section">
                    <h3>Payment</h3>
                    <p class="payment-info">Secure payment by Stripe</p>
                    <div id="card-element">
                        <!-- Stripe Card Element will be inserted here -->
                    </div>
                    <div class="payment-placeholder">
                        <p>Demo mode - No real payment</p>
                    </div>
                </div>

                <div class="checkout-total">
                    <div class="checkout-total-row">
                        <span>Subtotal:</span>
                        <span id="checkout-subtotal">0 EUR</span>
                    </div>
                    <div class="checkout-total-row promo-discount-row" id="checkout-discount-row" style="display: none;">
                        <span>Discount (<span id="checkout-promo-code"></span>):</span>
                        <span id="checkout-discount">-0 EUR</span>
                    </div>
                    <div class="checkout-total-row checkout-total-final">
                        <span>Total to pay:</span>
                        <span id="checkout-total">0 EUR</span>
                    </div>
                </div>

                <button type="submit" class="btn-pay">Confirm and pay</button>
            </form>
        </div>
    </div>

    <!-- Order Confirmation Modal -->
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-icon">&#10003;</div>
            <h2>Order confirmed!</h2>
            <p>Thank you for your purchase. You will receive a confirmation email.</p>
            <p class="order-number">Order #<span id="order-number"></span></p>
            <a href="index.html#collection" class="btn-primary">Back to collection</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <img src="../image/logo-cove.png" alt="COVE" class="footer-logo-img">
                <p class="footer-tagline">Premium Streetwear</p>
                <p class="footer-credit">made by Clemence</p>
                <div class="language-selector">
                    <span>Language</span>
                    <div class="language-options">
                        <a href="../cart.html">FR</a>
                        <a href="cart.html" class="active">EN</a>
                    </div>
                </div>
            </div>
            <div class="footer-links">
                <div class="footer-column">
                    <h4>Navigation</h4>
                    <a href="index.html#collection">Collection</a>
                    <a href="index.html#lookbook">Lookbook</a>
                    <a href="about.html">About</a>
                </div>
                <div class="footer-column">
                    <h4>Contact</h4>
                    <a href="contact.html">Contact us</a>
                    <a href="https://www.instagram.com/covestudio.off/" target="_blank">Instagram</a>
                    <a href="https://www.tiktok.com/@covestudio.off" target="_blank">TikTok</a>
                </div>
                <div class="footer-column">
                    <h4>Legal</h4>
                    <a href="cgv.html">Terms of Sale</a>
                    <a href="mentions-legales.html">Legal Notice</a>
                    <a href="confidentialite.html">Privacy Policy</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 COVE. All rights reserved.</p>
        </div>
    </footer>

    <script src="../js/cart.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // Render cart items
        function renderCart() {
            const cartItemsEl = document.getElementById('cart-items');
            const cartEmptyEl = document.getElementById('cart-empty');
            const cartSummaryEl = document.getElementById('cart-summary');

            if (cart.length === 0) {
                cartItemsEl.style.display = 'none';
                cartSummaryEl.style.display = 'none';
                cartEmptyEl.style.display = 'block';
                return;
            }

            cartItemsEl.style.display = 'block';
            cartSummaryEl.style.display = 'block';
            cartEmptyEl.style.display = 'none';

            cartItemsEl.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="cart-item-details">
                        <h4>${item.name}${item.size ? ` â€” Size ${item.size}` : ''}</h4>
                        <p class="cart-item-price">${item.price} EUR</p>
                    </div>
                    <div class="cart-item-quantity">
                        <button onclick="updateQuantity(${item.id}, -1, ${item.size ? `'${item.size}'` : 'null'})">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, 1, ${item.size ? `'${item.size}'` : 'null'})">+</button>
                    </div>
                    <div class="cart-item-total">
                        ${item.price * item.quantity} EUR
                    </div>
                    <button class="cart-item-remove" onclick="removeFromCart(${item.id}, ${item.size ? `'${item.size}'` : 'null'})">
                        &times;
                    </button>
                </div>
            `).join('');

            // Update totals
            const total = getCartTotal();
            document.getElementById('subtotal').textContent = total + ' EUR';
            document.getElementById('total').textContent = total + ' EUR';
            document.getElementById('checkout-subtotal').textContent = total + ' EUR';
            updateCheckoutTotal();
        }

        // Promo code state
        let appliedPromo = null;

        function updateCheckoutTotal() {
            const subtotal = getCartTotal();
            let total = subtotal;

            if (appliedPromo) {
                total = subtotal - appliedPromo.amount;
                if (total < 0) total = 0;
                document.getElementById('checkout-discount-row').style.display = 'flex';
                document.getElementById('checkout-promo-code').textContent = appliedPromo.code;
                document.getElementById('checkout-discount').textContent = '-' + appliedPromo.amount.toFixed(2) + ' EUR';
            } else {
                document.getElementById('checkout-discount-row').style.display = 'none';
            }

            document.getElementById('checkout-total').textContent = total.toFixed(2) + ' EUR';
        }

        async function applyPromoCode() {
            const input = document.getElementById('promo-code-input');
            const messageEl = document.getElementById('promo-message');
            const code = input.value.trim();

            if (!code) {
                messageEl.textContent = 'Please enter a promo code';
                messageEl.className = 'promo-message promo-error';
                return;
            }

            const subtotal = getCartTotal();
            const result = await api.validatePromoCode(code, subtotal);

            if (result.success) {
                appliedPromo = result.discount;
                messageEl.textContent = result.discount.type === 'percentage'
                    ? `Code ${result.discount.code} applied: -${result.discount.value}%`
                    : `Code ${result.discount.code} applied: -${result.discount.amount.toFixed(2)} EUR`;
                messageEl.className = 'promo-message promo-success';
                input.disabled = true;
                updateCheckoutTotal();
            } else {
                appliedPromo = null;
                messageEl.textContent = result.error || 'Invalid promo code';
                messageEl.className = 'promo-message promo-error';
                updateCheckoutTotal();
            }
        }

        function resetPromoCode() {
            appliedPromo = null;
            const input = document.getElementById('promo-code-input');
            if (input) {
                input.value = '';
                input.disabled = false;
            }
            const messageEl = document.getElementById('promo-message');
            if (messageEl) {
                messageEl.textContent = '';
                messageEl.className = 'promo-message';
            }
            updateCheckoutTotal();
        }

        // Proceed to checkout
        function proceedToCheckout() {
            if (cart.length === 0) return;
            document.getElementById('checkout-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close checkout
        function closeCheckout() {
            document.getElementById('checkout-modal').classList.remove('active');
            document.body.style.overflow = '';
            resetPromoCode();
        }

        // Submit order
        async function submitOrder(e) {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const formData = new FormData(e.target);
            const customer = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone')
            };
            const shipping = {
                address: formData.get('address'),
                city: formData.get('city'),
                postalCode: formData.get('postalCode'),
                country: formData.get('country')
            };

            const items = cart.map(item => ({
                id: item.id,
                quantity: item.quantity,
                size: item.size || null
            }));

            try {
                const promoCode = appliedPromo ? appliedPromo.code : null;
                const result = await api.checkout(items, customer, shipping, promoCode);

                if (result.success) {
                    if (result.url) {
                        window.location.href = result.url;
                        return;
                    }

                    document.getElementById('order-number').textContent = result.order.orderNumber;
                    closeCheckout();
                    resetPromoCode();
                    document.getElementById('confirmation-modal').classList.add('active');
                    clearCart();
                    renderCart();
                } else {
                    alert('Error: ' + (result.error || 'An error occurred'));
                }
            } catch (error) {
                console.error('Checkout error:', error);
                const orderNumber = 'COVE-' + Date.now().toString(36).toUpperCase();
                document.getElementById('order-number').textContent = orderNumber;
                closeCheckout();
                document.getElementById('confirmation-modal').classList.add('active');
                clearCart();
                renderCart();
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Confirm and pay';
        }

        // Close confirmation and redirect
        document.getElementById('confirmation-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('confirmation-modal')) {
                document.getElementById('confirmation-modal').classList.remove('active');
            }
        });

        // Handle Stripe return
        async function handleStripeReturn() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session_id');
            const success = params.get('success');
            const canceled = params.get('canceled');
            const orderParam = params.get('order');

            // Clean URL
            if (success || canceled) {
                history.replaceState({}, '', window.location.pathname);
            }

            if (success === 'true' && sessionId) {
                try {
                    const result = await api.verifyPayment(sessionId);
                    if (result.success && result.paid) {
                        document.getElementById('order-number').textContent = result.orderNumber || '';
                        document.getElementById('confirmation-modal').classList.add('active');
                        clearCart();
                        renderCart();
                    }
                } catch (error) {
                    console.error('Payment verification error:', error);
                }
            } else if (success === 'true' && orderParam) {
                // Demo return (no session_id)
                document.getElementById('order-number').textContent = orderParam;
                document.getElementById('confirmation-modal').classList.add('active');
                clearCart();
                renderCart();
            } else if (canceled === 'true') {
                alert('Payment canceled. Your cart has been kept.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderCart();
            handleStripeReturn();
        });
    </script>
</body>
</html>
