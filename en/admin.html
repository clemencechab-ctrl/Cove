<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVE - Administration</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="nav-left">
                <a href="index.html#collection" class="nav-link">Collection</a>
                <a href="index.html#lookbook" class="nav-link">Lookbook</a>
            </div>
            <div class="logo">
                <a href="index.html"><img src="../image/logo-cove.png" alt="COVE"></a>
            </div>
            <div class="nav-right">
                <a href="admin.html" class="nav-link active">Administration</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <a href="compte.html" class="nav-link">Account</a>
                <a href="cart.html" class="nav-link">Cart (<span id="cart-count">0</span>)</a>
            </div>
        </nav>
    </header>

    <!-- Admin Hero -->
    <section class="legal-hero">
        <h1 class="legal-title">Administration</h1>
        <p class="legal-subtitle">Real-time dashboard</p>
    </section>

    <!-- Access Denied -->
    <section class="admin-section" id="access-denied" style="display: none;">
        <div class="access-denied-content">
            <h2>Access Denied</h2>
            <p>You must be logged in as an administrator to access this page.</p>
            <a href="compte.html" class="btn-primary">Sign In</a>
        </div>
    </section>

    <!-- Admin Content -->
    <div id="admin-content" style="display: none;">
        <!-- Logout -->
        <div style="text-align: right; padding: 0 2rem;">
            <button class="btn-logout" id="admin-logout">Sign out</button>
        </div>

        <!-- Admin Tabs -->
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="tab-dashboard">Dashboard</button>
            <button class="admin-tab" data-tab="tab-products">Products</button>
            <button class="admin-tab" data-tab="tab-promos">Promo Codes</button>
            <button class="admin-tab" data-tab="tab-messages">Messages</button>
        </div>

        <!-- Tab: Dashboard -->
        <div id="tab-dashboard" class="admin-tab-content active">
            <section class="admin-section">
                <div id="admin-stats" class="admin-stats">
                    <div class="stat-card">
                        <span class="stat-value" id="stat-total-orders">-</span>
                        <span class="stat-label">Orders</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="stat-total-revenue">-</span>
                        <span class="stat-label">Revenue</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="stat-total-clients">-</span>
                        <span class="stat-label">Clients</span>
                    </div>
                </div>
            </section>

            <section class="admin-section">
                <h2 class="section-title" style="text-align:center; margin-bottom:2rem;">Clients &amp; Orders</h2>
                <!-- Filter Bar -->
                <div class="admin-filter-bar">
                    <input type="text" id="filter-search" class="admin-filter-input" placeholder="Search by email or order number...">
                    <select id="filter-status" class="admin-filter-select">
                        <option value="">All statuses</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div id="admin-clients" class="admin-clients">
                    <p style="text-align:center; color: var(--color-text-muted);">Loading...</p>
                </div>
            </section>
        </div>

        <!-- Tab: Products -->
        <div id="tab-products" class="admin-tab-content">
            <section class="admin-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h2 class="section-title" style="margin:0;">Products</h2>
                    <button class="btn-primary" onclick="openProductModal()">Add product</button>
                </div>
                <div id="admin-products-list" class="admin-products-list">
                    <p style="text-align:center; color: var(--color-text-muted);">Loading...</p>
                </div>
            </section>
        </div>

        <!-- Tab: Promo Codes -->
        <div id="tab-promos" class="admin-tab-content">
            <section class="admin-section">
                <h2 class="section-title" style="text-align:center; margin-bottom:2rem;">Promo Codes</h2>
                <div class="admin-promo-form">
                    <h3>Create a promo code</h3>
                    <div class="promo-form-grid">
                        <div class="form-group">
                            <label>Code</label>
                            <input type="text" id="promo-code" placeholder="e.g. COVE20" style="text-transform:uppercase">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="promo-type">
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed">Fixed amount (EUR)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Value</label>
                            <input type="number" id="promo-value" min="0" step="1" placeholder="20">
                        </div>
                        <div class="form-group">
                            <label>Min. order (EUR)</label>
                            <input type="number" id="promo-min-order" min="0" step="1" placeholder="0" value="0">
                        </div>
                        <div class="form-group">
                            <label>Max uses</label>
                            <input type="number" id="promo-max-uses" min="0" step="1" placeholder="0 = unlimited" value="0">
                        </div>
                        <div class="form-group" style="display:flex; align-items:flex-end;">
                            <button class="btn-primary" onclick="createPromo()" style="width:100%;">Create</button>
                        </div>
                    </div>
                    <p id="promo-form-message" class="admin-form-message"></p>
                </div>
                <div id="admin-promos-list" class="admin-promos-list">
                    <p style="text-align:center; color: var(--color-text-muted);">Loading...</p>
                </div>
            </section>
        </div>

        <!-- Tab: Messages -->
        <div id="tab-messages" class="admin-tab-content">
            <section class="admin-section">
                <h2 class="section-title" style="text-align:center; margin-bottom:2rem;">Contact Messages</h2>
                <div id="admin-messages-list" class="admin-messages-list">
                    <p style="text-align:center; color: var(--color-text-muted);">Loading...</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="admin-modal" id="product-modal">
        <div class="admin-modal-content">
            <button class="admin-modal-close" onclick="closeProductModal()">&times;</button>
            <h2 id="product-modal-title">Add product</h2>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-edit-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Price (EUR)</label>
                        <input type="number" id="product-price" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="product-category" required>
                            <option value="tops">Tops</option>
                            <option value="bottoms">Bottoms</option>
                            <option value="outerwear">Outerwear</option>
                            <option value="accessories">Accessories</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="product-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Image URL</label>
                    <input type="text" id="product-image" placeholder="image/myproduct.jpg">
                </div>
                <div class="form-group">
                    <label>Stock per size</label>
                    <div class="size-stock-grid">
                        <div><label>S</label><input type="number" id="stock-s" min="0" value="0"></div>
                        <div><label>M</label><input type="number" id="stock-m" min="0" value="0"></div>
                        <div><label>L</label><input type="number" id="stock-l" min="0" value="0"></div>
                        <div><label>XL</label><input type="number" id="stock-xl" min="0" value="0"></div>
                    </div>
                </div>
                <p id="product-form-message" class="admin-form-message"></p>
                <button type="submit" class="btn-primary" style="width:100%; margin-top:1rem;">Save</button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <img src="../image/logo-cove.png" alt="COVE" class="footer-logo-img">
                <p class="footer-tagline">Premium Streetwear</p>
                <p class="footer-credit">made by Clemence</p>
                <div class="language-selector">
                    <span>Language</span>
                    <div class="language-options">
                        <a href="../admin.html">FR</a>
                        <a href="admin.html" class="active">EN</a>
                    </div>
                </div>
            </div>
            <div class="footer-links">
                <div class="footer-column">
                    <h4>Navigation</h4>
                    <a href="index.html#collection">Collection</a>
                    <a href="index.html#lookbook">Lookbook</a>
                    <a href="about.html">About</a>
                </div>
                <div class="footer-column">
                    <h4>Contact</h4>
                    <a href="contact.html">Contact us</a>
                    <a href="https://www.instagram.com/covestudio.off/" target="_blank">Instagram</a>
                    <a href="https://www.tiktok.com/@covestudio.off" target="_blank">TikTok</a>
                </div>
                <div class="footer-column">
                    <h4>Legal</h4>
                    <a href="cgv.html">Terms</a>
                    <a href="mentions-legales.html">Legal</a>
                    <a href="confidentialite.html">Privacy</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 COVE. All rights reserved.</p>
        </div>
    </footer>

    <script src="../js/cart.js"></script>
    <script src="../js/api.js"></script>
    <script>
        const statusLabels = {
            pending: { label: 'Pending', class: 'status-pending' },
            paid: { label: 'Paid', class: 'status-confirmed' },
            confirmed: { label: 'Confirmed', class: 'status-confirmed' },
            processing: { label: 'Processing', class: 'status-processing' },
            shipped: { label: 'Shipped', class: 'status-shipped' },
            delivered: { label: 'Delivered', class: 'status-delivered' },
            cancelled: { label: 'Cancelled', class: 'status-cancelled' }
        };

        const messageStatusLabels = {
            new: { label: 'New', class: 'msg-status-new' },
            read: { label: 'Read', class: 'msg-status-read' },
            replied: { label: 'Replied', class: 'msg-status-replied' },
            archived: { label: 'Archived', class: 'msg-status-archived' }
        };

        const categoryLabels = {
            tops: 'Tops', bottoms: 'Bottoms', outerwear: 'Outerwear', accessories: 'Accessories'
        };

        // ============ Tabs ============
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // ============ Admin Access ============
        async function checkAdminAccess() {
            const token = localStorage.getItem('coveToken');
            const userStr = localStorage.getItem('coveUser');
            if (!token || !userStr) { showAccessDenied(); return false; }
            try {
                const user = JSON.parse(userStr);
                if (user.role !== 'owner') { showAccessDenied(); return false; }
                return true;
            } catch (e) { showAccessDenied(); return false; }
        }

        function showAccessDenied() {
            document.getElementById('access-denied').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
        }

        function showAdminContent() {
            document.getElementById('access-denied').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
        }

        // ============ Dashboard ============
        async function loadStats() {
            const result = await api.getAdminStats();
            if (result.success) {
                document.getElementById('stat-total-orders').textContent = result.stats.totalOrders;
                document.getElementById('stat-total-revenue').textContent = result.stats.totalRevenue + ' EUR';
                document.getElementById('stat-total-clients').textContent = result.stats.totalClients;
            }
        }

        async function loadClients() {
            const container = document.getElementById('admin-clients');
            const result = await api.getAdminClients();

            if (!result.success) {
                container.innerHTML = '<p style="text-align:center; color: #e74c3c;">Error: ' + (result.error || 'Unable to load clients') + '</p>';
                return;
            }

            if (result.clients.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--color-text-muted);">No clients yet.</p>';
                return;
            }

            container.innerHTML = result.clients.map(client => {
                const lastLogin = client.lastLogin
                    ? new Date(client.lastLogin).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                    : 'Never';
                const createdAt = client.createdAt
                    ? new Date(client.createdAt).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' })
                    : '-';

                const ordersHtml = client.orders.length > 0
                    ? client.orders.map(order => {
                        const status = statusLabels[order.status] || { label: order.status, class: '' };
                        const orderDate = new Date(order.createdAt).toLocaleDateString('en-US');
                        return `
                            <div class="order-row" data-status="${order.status}" data-order-number="${order.orderNumber}">
                                <div class="order-info">
                                    <span class="order-number">${order.orderNumber}</span>
                                    <span class="order-date">${orderDate}</span>
                                    <span class="order-total">${order.total} EUR</span>
                                </div>
                                <div class="order-actions">
                                    <span class="status-badge ${status.class}">${status.label}</span>
                                    <select class="status-select" data-order-id="${order.id}" onchange="updateStatus(this)">
                                        <option value="">Change status...</option>
                                        <option value="confirmed">Confirm</option>
                                        <option value="processing">Processing</option>
                                        <option value="shipped">Ship</option>
                                        <option value="delivered">Delivered</option>
                                        <option value="cancelled">Cancel</option>
                                    </select>
                                </div>
                                <div class="order-tracking">
                                    <input type="text" class="tracking-input" id="tracking-${order.id}" placeholder="Tracking number" value="${order.trackingNumber || ''}" />
                                    <button class="btn-admin-action btn-tracking" onclick="setTracking('${order.id}', this)">Track</button>
                                </div>
                                <div class="order-items">
                                    ${order.items.map(i => `<span class="order-item-pill">${i.name} x${i.quantity}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<p style="color: var(--color-text-muted); font-size: 0.9rem;">No orders</p>';

                return `
                    <div class="client-card" data-email="${client.email}">
                        <div class="client-header">
                            <div>
                                <div class="client-name">${client.email}</div>
                                <div class="client-meta">
                                    <span>Registered on ${createdAt}</span>
                                    <span class="client-separator">|</span>
                                    <span>${client.ordersCount} order(s)</span>
                                    <span class="client-separator">|</span>
                                    <span>Total: ${client.totalSpent} EUR</span>
                                </div>
                            </div>
                            <div class="client-last-login">
                                <span class="last-login-label">Last login</span>
                                <span class="last-login-value">${lastLogin}</span>
                            </div>
                        </div>
                        <div class="client-orders">${ordersHtml}</div>
                    </div>
                `;
            }).join('');
        }

        // ============ Filters ============
        function applyFilters() {
            const search = document.getElementById('filter-search').value.toLowerCase().trim();
            const statusFilter = document.getElementById('filter-status').value;

            document.querySelectorAll('.client-card').forEach(card => {
                const email = (card.dataset.email || '').toLowerCase();
                const orders = card.querySelectorAll('.order-row');
                let hasVisibleOrder = false;

                if (orders.length === 0) {
                    const matchSearch = !search || email.includes(search);
                    const matchStatus = !statusFilter;
                    card.style.display = (matchSearch && matchStatus) ? '' : 'none';
                    return;
                }

                orders.forEach(row => {
                    const orderNum = (row.dataset.orderNumber || '').toLowerCase();
                    const orderStatus = row.dataset.status;
                    const matchSearch = !search || email.includes(search) || orderNum.includes(search);
                    const matchStatus = !statusFilter || orderStatus === statusFilter;
                    row.style.display = (matchSearch && matchStatus) ? '' : 'none';
                    if (matchSearch && matchStatus) hasVisibleOrder = true;
                });

                const matchEmail = !search || email.includes(search);
                card.style.display = (matchEmail && (hasVisibleOrder || !statusFilter)) ? '' : 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('filter-search');
            const statusSelect = document.getElementById('filter-status');
            if (searchInput) searchInput.addEventListener('input', applyFilters);
            if (statusSelect) statusSelect.addEventListener('change', applyFilters);
        });

        // ============ Order Status ============
        async function updateStatus(select) {
            const orderId = select.dataset.orderId;
            const status = select.value;
            if (!status) return;

            select.disabled = true;
            const result = await api.updateOrderStatus(orderId, status);

            if (result.success) {
                await loadClients();
                applyFilters();
            } else {
                alert('Error: ' + (result.error || 'Unable to update status'));
                select.value = '';
            }
            select.disabled = false;
        }

        // ============ Tracking ============
        async function setTracking(orderId, btn) {
            const input = document.getElementById('tracking-' + orderId);
            const trackingNumber = input.value.trim();
            if (!trackingNumber) { alert('Please enter a tracking number'); return; }
            btn.disabled = true;
            const result = await api.setOrderTracking(orderId, trackingNumber);
            if (result.success) {
                btn.textContent = 'OK';
                setTimeout(() => { btn.textContent = 'Track'; btn.disabled = false; }, 2000);
            } else {
                alert('Error: ' + (result.error || 'Unable to save'));
                btn.disabled = false;
            }
        }

        // ============ Products ============
        async function loadProducts() {
            const container = document.getElementById('admin-products-list');
            const result = await api.getAdminProducts();

            if (!result.success) {
                container.innerHTML = '<p style="text-align:center; color: #e74c3c;">Loading error</p>';
                return;
            }

            if (!result.products || result.products.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--color-text-muted);">No products.</p>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Stock (S/M/L/XL)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${result.products.map(p => {
                            const ss = p.sizeStock || {};
                            const stockStr = `${ss.S || 0} / ${ss.M || 0} / ${ss.L || 0} / ${ss.XL || 0}`;
                            const totalStock = (ss.S || 0) + (ss.M || 0) + (ss.L || 0) + (ss.XL || 0);
                            const cat = categoryLabels[p.category] || p.category;
                            const imgSrc = p.image || 'https://via.placeholder.com/60';
                            return `
                                <tr>
                                    <td><img src="${imgSrc}" alt="${p.name}" class="admin-product-thumb"></td>
                                    <td>${p.name}</td>
                                    <td>${p.price} EUR</td>
                                    <td>${cat}</td>
                                    <td>${stockStr} <span style="color:var(--color-text-muted);">(${totalStock})</span></td>
                                    <td>
                                        <button class="btn-admin-action" onclick="editProduct('${p.id}')">Edit</button>
                                        <button class="btn-admin-action btn-admin-danger" onclick="deleteProduct('${p.id}', '${p.name.replace(/'/g, "\\'")}')">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function openProductModal(product = null) {
            document.getElementById('product-modal').classList.add('active');
            document.getElementById('product-form-message').textContent = '';
            if (product) {
                document.getElementById('product-modal-title').textContent = 'Edit product';
                document.getElementById('product-edit-id').value = product.id;
                document.getElementById('product-name').value = product.name || '';
                document.getElementById('product-price').value = product.price || '';
                document.getElementById('product-category').value = product.category || 'tops';
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-image').value = product.image || '';
                const ss = product.sizeStock || {};
                document.getElementById('stock-s').value = ss.S || 0;
                document.getElementById('stock-m').value = ss.M || 0;
                document.getElementById('stock-l').value = ss.L || 0;
                document.getElementById('stock-xl').value = ss.XL || 0;
            } else {
                document.getElementById('product-modal-title').textContent = 'Add product';
                document.getElementById('product-edit-id').value = '';
                document.getElementById('product-form').reset();
                document.getElementById('stock-s').value = 0;
                document.getElementById('stock-m').value = 0;
                document.getElementById('stock-l').value = 0;
                document.getElementById('stock-xl').value = 0;
            }
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
        }

        async function editProduct(id) {
            const result = await api.getAdminProducts();
            if (result.success) {
                const product = result.products.find(p => p.id === id);
                if (product) openProductModal(product);
            }
        }

        async function saveProduct(e) {
            e.preventDefault();
            const msgEl = document.getElementById('product-form-message');
            const editId = document.getElementById('product-edit-id').value;

            const data = {
                name: document.getElementById('product-name').value.trim(),
                price: parseFloat(document.getElementById('product-price').value),
                category: document.getElementById('product-category').value,
                description: document.getElementById('product-description').value.trim(),
                image: document.getElementById('product-image').value.trim(),
                sizeStock: {
                    S: parseInt(document.getElementById('stock-s').value) || 0,
                    M: parseInt(document.getElementById('stock-m').value) || 0,
                    L: parseInt(document.getElementById('stock-l').value) || 0,
                    XL: parseInt(document.getElementById('stock-xl').value) || 0
                }
            };

            let result;
            if (editId) {
                result = await api.updateProduct(editId, data);
            } else {
                result = await api.createProduct(data);
            }

            if (result.success) {
                closeProductModal();
                await loadProducts();
            } else {
                msgEl.textContent = result.error || 'Error saving product';
                msgEl.className = 'admin-form-message error';
            }
        }

        async function deleteProduct(id, name) {
            if (!confirm(`Delete product "${name}"?`)) return;
            const result = await api.deleteProduct(id);
            if (result.success) {
                await loadProducts();
            } else {
                alert('Error: ' + (result.error || 'Unable to delete'));
            }
        }

        // ============ Promo Codes ============
        async function loadPromos() {
            const container = document.getElementById('admin-promos-list');
            const result = await api.getAdminPromoCodes();

            if (!result.success) {
                container.innerHTML = '<p style="text-align:center; color: #e74c3c;">Loading error</p>';
                return;
            }

            if (!result.promoCodes || result.promoCodes.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--color-text-muted);">No promo codes.</p>';
                return;
            }

            container.innerHTML = result.promoCodes.map(promo => {
                const typeLabel = promo.type === 'percentage' ? `${promo.value}%` : `${promo.value} EUR`;
                const usesLabel = promo.maxUses > 0 ? `${promo.usedCount || 0}/${promo.maxUses}` : `${promo.usedCount || 0}/unlimited`;
                return `
                    <div class="promo-card">
                        <div class="promo-card-info">
                            <span class="promo-card-code">${promo.code}</span>
                            <span class="promo-card-value">${typeLabel}</span>
                            <span class="promo-card-meta">Min: ${promo.minOrder || 0} EUR | Uses: ${usesLabel}</span>
                        </div>
                        <button class="btn-admin-action btn-admin-danger" onclick="deletePromo('${promo.id}', '${promo.code}')">Delete</button>
                    </div>
                `;
            }).join('');
        }

        async function createPromo() {
            const msgEl = document.getElementById('promo-form-message');
            const data = {
                code: document.getElementById('promo-code').value.trim().toUpperCase(),
                type: document.getElementById('promo-type').value,
                value: parseFloat(document.getElementById('promo-value').value),
                minOrder: parseFloat(document.getElementById('promo-min-order').value) || 0,
                maxUses: parseInt(document.getElementById('promo-max-uses').value) || 0
            };

            if (!data.code || !data.value) {
                msgEl.textContent = 'Code and value are required';
                msgEl.className = 'admin-form-message error';
                return;
            }

            const result = await api.createPromoCode(data);
            if (result.success) {
                msgEl.textContent = 'Promo code created!';
                msgEl.className = 'admin-form-message success';
                document.getElementById('promo-code').value = '';
                document.getElementById('promo-value').value = '';
                await loadPromos();
            } else {
                msgEl.textContent = result.error || 'Creation error';
                msgEl.className = 'admin-form-message error';
            }
        }

        async function deletePromo(id, code) {
            if (!confirm(`Delete code "${code}"?`)) return;
            const result = await api.deletePromoCode(id);
            if (result.success) {
                await loadPromos();
            } else {
                alert('Error: ' + (result.error || 'Unable to delete'));
            }
        }

        // ============ Messages ============
        async function loadMessages() {
            const container = document.getElementById('admin-messages-list');
            const result = await api.getAdminMessages();

            if (!result.success) {
                container.innerHTML = '<p style="text-align:center; color: #e74c3c;">Loading error</p>';
                return;
            }

            if (!result.messages || result.messages.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--color-text-muted);">No messages.</p>';
                return;
            }

            container.innerHTML = result.messages.map(msg => {
                const statusInfo = messageStatusLabels[msg.status] || { label: msg.status, class: '' };
                const date = msg.createdAt ? new Date(msg.createdAt).toLocaleDateString('en-US', {
                    day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                }) : '-';

                return `
                    <div class="message-card" onclick="toggleMessage(this)">
                        <div class="message-card-header">
                            <div class="message-card-info">
                                <span class="message-card-name">${msg.name || 'Anonymous'}</span>
                                <span class="message-card-email">${msg.email || ''}</span>
                                <span class="message-card-date">${date}</span>
                            </div>
                            <div class="message-card-right">
                                <span class="message-status-badge ${statusInfo.class}">${statusInfo.label}</span>
                                <select class="status-select" onclick="event.stopPropagation()" onchange="updateMessageStatus('${msg.id}', this.value, this)">
                                    <option value="">Change...</option>
                                    <option value="read">Read</option>
                                    <option value="replied">Replied</option>
                                    <option value="archived">Archive</option>
                                </select>
                            </div>
                        </div>
                        <div class="message-card-subject">${msg.subject || 'No subject'}</div>
                        <div class="message-card-body">${msg.message || ''}</div>
                    </div>
                `;
            }).join('');
        }

        function toggleMessage(card) {
            card.classList.toggle('expanded');
        }

        async function updateMessageStatus(id, status, select) {
            if (!status) return;
            select.disabled = true;
            const result = await api.updateMessageStatus(id, status);
            if (result.success) {
                await loadMessages();
            } else {
                alert('Error: ' + (result.error || 'Unable to update'));
            }
            select.disabled = false;
        }

        // ============ Logout ============
        function adminLogout() {
            localStorage.removeItem('coveToken');
            localStorage.removeItem('coveUser');
            window.location.href = 'compte.html';
        }

        // ============ Init ============
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('admin-logout').addEventListener('click', adminLogout);

            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                showAdminContent();
                await Promise.all([loadStats(), loadClients(), loadProducts(), loadPromos(), loadMessages()]);
            }
        });
    </script>
</body>
</html>
