<!DOCTYPE html>
<html lang="fr" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVE - Panier</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="nav-left">
                <a href="index.html#collection" class="nav-link">Collection</a>
                <a href="index.html#lookbook" class="nav-link">Lookbook</a>
            </div>
            <div class="logo">
                <a href="index.html"><img src="image/logo-cove.png" alt="COVE"></a>
            </div>
            <div class="nav-right">
                <a href="admin.html" class="nav-link">Administration</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <a href="compte.html" class="nav-link">Compte</a>
                <a href="cart.html" class="nav-link cart-link active">
                    Panier (<span id="cart-count">0</span>)
                </a>
            </div>
        </nav>
    </header>

    <!-- Cart Hero -->
    <section class="cart-hero">
        <h1 class="cart-title">Panier</h1>
    </section>

    <!-- Cart Section -->
    <section class="cart-section">
        <div class="cart-container">
            <!-- Cart Items -->
            <div class="cart-items" id="cart-items">
                <!-- Items will be rendered by JavaScript -->
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary" id="cart-summary">
                <h3>Recapitulatif</h3>
                <div class="summary-row">
                    <span>Sous-total</span>
                    <span id="subtotal">0 EUR</span>
                </div>
                <div class="summary-row">
                    <span>Livraison</span>
                    <span id="shipping">Gratuite</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="total">0 EUR</span>
                </div>
                <button class="btn-checkout" id="checkout-btn" onclick="proceedToCheckout()">
                    Passer la commande
                </button>
                <a href="index.html#collection" class="btn-continue">Continuer mes achats</a>
            </div>
        </div>

        <!-- Empty Cart Message -->
        <div class="cart-empty" id="cart-empty" style="display: none;">
            <p>Votre panier est vide</p>
            <a href="index.html#collection" class="btn-primary">Voir la collection</a>
        </div>
    </section>

    <!-- Checkout Modal -->
    <div class="checkout-modal" id="checkout-modal">
        <div class="checkout-content">
            <button class="checkout-close" onclick="closeCheckout()">&times;</button>
            <h2>Finaliser la commande</h2>

            <form id="checkout-form" onsubmit="submitOrder(event)">
                <div class="checkout-section">
                    <h3>Informations de livraison</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">Prenom</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Nom</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Telephone</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Adresse</label>
                        <input type="text" id="address" name="address" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">Ville</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="postalCode">Code postal</label>
                            <input type="text" id="postalCode" name="postalCode" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="country">Pays</label>
                        <select id="country" name="country" required>
                            <option value="FR">France</option>
                            <option value="BE">Belgique</option>
                            <option value="CH">Suisse</option>
                            <option value="LU">Luxembourg</option>
                        </select>
                    </div>
                </div>

                <div class="checkout-section">
                    <h3>Paiement</h3>
                    <p class="payment-info">Paiement securise par Stripe</p>
                    <div id="card-element">
                        <!-- Stripe Card Element will be inserted here -->
                    </div>
                    <div class="payment-placeholder">
                        <p>Mode demo - Aucun paiement reel</p>
                    </div>
                </div>

                <div class="checkout-total">
                    <span>Total a payer:</span>
                    <span id="checkout-total">0 EUR</span>
                </div>

                <button type="submit" class="btn-pay">Confirmer et payer</button>
            </form>
        </div>
    </div>

    <!-- Order Confirmation Modal -->
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-icon">&#10003;</div>
            <h2>Commande confirmee !</h2>
            <p>Merci pour votre achat. Vous recevrez un email de confirmation.</p>
            <p class="order-number">Commande #<span id="order-number"></span></p>
            <a href="index.html#collection" class="btn-primary">Retour a la collection</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <img src="image/logo-cove.png" alt="COVE" class="footer-logo-img">
                <p class="footer-tagline">Streetwear Premium</p>
                <p class="footer-credit">made by Clemence</p>
                <div class="language-selector">
                    <span>Langue</span>
                    <div class="language-options">
                        <a href="cart.html" class="active">FR</a>
                        <a href="en/cart.html">EN</a>
                    </div>
                </div>
            </div>
            <div class="footer-links">
                <div class="footer-column">
                    <h4>Navigation</h4>
                    <a href="index.html#collection">Collection</a>
                    <a href="index.html#lookbook">Lookbook</a>
                    <a href="about.html">About</a>
                </div>
                <div class="footer-column">
                    <h4>Contact</h4>
                    <a href="contact.html">Nous contacter</a>
                    <a href="https://www.instagram.com/covestudio.off/" target="_blank">Instagram</a>
                    <a href="https://www.tiktok.com/@covestudio.off" target="_blank">TikTok</a>
                </div>
                <div class="footer-column">
                    <h4>Legal</h4>
                    <a href="cgv.html">CGV</a>
                    <a href="mentions-legales.html">Mentions legales</a>
                    <a href="confidentialite.html">Confidentialite</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 COVE. Tous droits reserves.</p>
        </div>
    </footer>

    <script src="js/cart.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Render cart items
        function renderCart() {
            const cartItemsEl = document.getElementById('cart-items');
            const cartEmptyEl = document.getElementById('cart-empty');
            const cartSummaryEl = document.getElementById('cart-summary');

            if (cart.length === 0) {
                cartItemsEl.style.display = 'none';
                cartSummaryEl.style.display = 'none';
                cartEmptyEl.style.display = 'block';
                return;
            }

            cartItemsEl.style.display = 'block';
            cartSummaryEl.style.display = 'block';
            cartEmptyEl.style.display = 'none';

            cartItemsEl.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="cart-item-details">
                        <h4>${item.name}${item.size ? ` — Taille ${item.size}` : ''}</h4>
                        <p class="cart-item-price">${item.price} EUR</p>
                    </div>
                    <div class="cart-item-quantity">
                        <button onclick="updateQuantity(${item.id}, -1, ${item.size ? `'${item.size}'` : 'null'})">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, 1, ${item.size ? `'${item.size}'` : 'null'})">+</button>
                    </div>
                    <div class="cart-item-total">
                        ${item.price * item.quantity} EUR
                    </div>
                    <button class="cart-item-remove" onclick="removeFromCart(${item.id}, ${item.size ? `'${item.size}'` : 'null'})">
                        &times;
                    </button>
                </div>
            `).join('');

            // Update totals
            const total = getCartTotal();
            document.getElementById('subtotal').textContent = total + ' EUR';
            document.getElementById('total').textContent = total + ' EUR';
            document.getElementById('checkout-total').textContent = total + ' EUR';
        }

        // Proceed to checkout
        function proceedToCheckout() {
            if (cart.length === 0) return;
            document.getElementById('checkout-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close checkout
        function closeCheckout() {
            document.getElementById('checkout-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Submit order
        async function submitOrder(e) {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Traitement...';

            // Récupérer les données du formulaire
            const formData = new FormData(e.target);
            const customer = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone')
            };
            const shipping = {
                address: formData.get('address'),
                city: formData.get('city'),
                postalCode: formData.get('postalCode'),
                country: formData.get('country')
            };

            // Préparer les items (avec taille si applicable)
            const items = cart.map(item => ({
                id: item.id,
                quantity: item.quantity,
                size: item.size || null
            }));

            try {
                // Appeler l'API backend
                const result = await api.checkout(items, customer, shipping);

                if (result.success) {
                    // Si Stripe est configuré, rediriger vers Stripe
                    if (result.url) {
                        window.location.href = result.url;
                        return;
                    }

                    // Mode démo - afficher la confirmation
                    document.getElementById('order-number').textContent = result.order.orderNumber;
                    closeCheckout();
                    document.getElementById('confirmation-modal').classList.add('active');
                    clearCart();
                    renderCart();
                } else {
                    alert('Erreur: ' + (result.error || 'Une erreur est survenue'));
                }
            } catch (error) {
                console.error('Checkout error:', error);
                // Fallback mode local si le backend n'est pas disponible
                const orderNumber = 'COVE-' + Date.now().toString(36).toUpperCase();
                document.getElementById('order-number').textContent = orderNumber;
                closeCheckout();
                document.getElementById('confirmation-modal').classList.add('active');
                clearCart();
                renderCart();
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Confirmer et payer';
        }

        // Close confirmation and redirect
        document.getElementById('confirmation-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('confirmation-modal')) {
                document.getElementById('confirmation-modal').classList.remove('active');
            }
        });

        // Gerer le retour Stripe
        async function handleStripeReturn() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session_id');
            const success = params.get('success');
            const canceled = params.get('canceled');
            const orderParam = params.get('order');

            // Nettoyer l'URL
            if (success || canceled) {
                history.replaceState({}, '', window.location.pathname);
            }

            if (success === 'true' && sessionId) {
                try {
                    const result = await api.verifyPayment(sessionId);
                    if (result.success && result.paid) {
                        document.getElementById('order-number').textContent = result.orderNumber || '';
                        document.getElementById('confirmation-modal').classList.add('active');
                        clearCart();
                        renderCart();
                    }
                } catch (error) {
                    console.error('Erreur verification paiement:', error);
                }
            } else if (success === 'true' && orderParam) {
                // Retour demo (pas de session_id)
                document.getElementById('order-number').textContent = orderParam;
                document.getElementById('confirmation-modal').classList.add('active');
                clearCart();
                renderCart();
            } else if (canceled === 'true') {
                alert('Paiement annule. Votre panier a ete conserve.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderCart();
            handleStripeReturn();
        });
    </script>
</body>
</html>
